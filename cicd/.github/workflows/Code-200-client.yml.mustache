name: Code-200-Client
on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  checks: write
  id-token: write

env:
  TF_VERSION: "1.12.2"
  AWS_REGION: {{region}}

jobs:
  client-operations:
    runs-on: ubuntu-latest
    steps:
      - name: Version of AWS CLI
        run: |
          echo "AWS CLI version:"
          which aws
          aws --version

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Configure AWS credentials
        uses: ./.github/actions/aws-credentials
        with:
          account-id: {{{githubVarsOpen}}} vars.AWS_ACCOUNT_ID {{{githubVarsClose}}}
          role-name: {{projectName}}-{{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}-ops-deploy-s3-role

      - name: Display Environment Info
        run: |
          echo "Event name: {{{githubVarsOpen}}} github.event_name  {{{githubVarsClose}}}"
          echo "Branch: {{{githubVarsOpen}}} env.BRANCH  {{{githubVarsClose}}}"
          echo "Environment: {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}"

      - name: Get Terraform Outputs
        id: tf-outputs
        uses: ./.github/actions/terraform-outputs
        with:
          terraform-dir: {{opsModule.moduleId}}/terraform
          environment: {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}}
          project-name: {{projectName}}

      - name: Verify Terraform Outputs
        run: |
          if [ -z "${AWS_S3_TARGET}" ]; then
            echo "‚ùå Could not get S3 bucket from Terraform outputs"
            echo "‚ö†Ô∏è Infrastructure may not be deployed yet - run deploy_apply first"
            exit 1
          fi

          if [ -z "${CLOUDFRONT_TARGET}" ]; then
            echo "‚ùå Could not get CloudFront distribution from Terraform outputs"
            echo "‚ö†Ô∏è Infrastructure may not be deployed yet - run deploy_apply first"
            exit 1
          fi

          echo "‚úÖ Found S3 bucket: ${AWS_S3_TARGET}"
          echo "‚úÖ Found CloudFront distribution: ${CLOUDFRONT_TARGET}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create version file
        uses: ./.github/actions/create-version-file
        with:
          output-path: src/utils/version.ts
          module-id: {{frontendModule.moduleId}}

      - name: Setup environment variables
        run: |
          cd {{frontendModule.moduleId}}
          echo "üìù Checking environment file for {{{githubVarsOpen}}} env.ENVIRONMENT {{{githubVarsClose}}} environment..."

          # Vite uses --mode flag to load .env.{mode} files
          # e.g., --mode dev loads .env + .env.dev
          ENV_FILE=".env.{{{githubVarsOpen}}} env.ENVIRONMENT {{{githubVarsClose}}}"
          if [ -f "$ENV_FILE" ]; then
            echo "‚úÖ Found $ENV_FILE - will use --mode {{{githubVarsOpen}}} env.ENVIRONMENT {{{githubVarsClose}}} for build"
          else
            echo "‚ö†Ô∏è Warning: $ENV_FILE not found, build will use base .env only"
          fi

          # List env files for debugging
          ls -la .env* || true

      - name: Build
        run: |
          cd {{frontendModule.moduleId}}
          ls -lart
          pwd
          node -v
          npm -v
          npm install
          npx update-browserslist-db@latest
          echo "üî® Running build for {{{githubVarsOpen}}} env.ENVIRONMENT  {{{githubVarsClose}}} environment..."
          CI=false npm run build -- --mode {{{githubVarsOpen}}} env.ENVIRONMENT {{{githubVarsClose}}}

      - name: Check and commit package-lock.json changes
        run: |
          cd {{frontendModule.moduleId}}

          # Check if package-lock.json exists and has changes
          if [ -f "package-lock.json" ]; then
            # Check if there are any changes to package-lock.json
            if git diff --quiet package-lock.json && git diff --cached --quiet package-lock.json; then
              echo "‚úÖ No changes to package-lock.json"
            else
              echo "üîÑ package-lock.json was modified during build, committing changes..."

              # Configure git for the action
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"

              # Add and commit the package-lock.json
              git add package-lock.json
              git commit -m "ü§ñ updated package-lock.json from build process"

              # Push the commit back to the repository
              git push
              echo "‚úÖ package-lock.json committed and pushed successfully"
            fi
          else
            echo "‚ÑπÔ∏è No package-lock.json found after build"
          fi

      - name: Deploy - Sync S3 Bucket
        run: |
          echo "Deploying to ${AWS_S3_TARGET} [${CLOUDFRONT_TARGET}]"
          aws s3 sync {{frontendModule.moduleId}}/dist "s3://${AWS_S3_TARGET}" --region {{{githubVarsOpen}}} env.AWS_REGION  {{{githubVarsClose}}} --delete

      - name: Deploy - Invalidate CloudFront cache
        run: |
          echo "Invalidating CloudFront distribution cache for ${CLOUDFRONT_TARGET}"
          aws cloudfront create-invalidation --distribution-id "${CLOUDFRONT_TARGET}" --paths "/*"

