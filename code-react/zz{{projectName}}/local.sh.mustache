#!/bin/bash
#
# Local Development Startup Script
# Generated by Genesis3 for {{{projectName}}}
#
# This script starts all services needed for local development:
{{#hasBackend}}
# - Backend API (via separate backend module)
{{/hasBackend}}
# - React/Vite frontend
#
# Usage: ./local.sh
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
PROJECT_NAME="{{{projectName}}}"

# Module directories
FRONTEND_DIR="$PROJECT_ROOT/{{{frontendModule.moduleId}}}"

# Ports
FRONTEND_PORT=5173

# PID file location
PID_DIR="$SCRIPT_DIR/.pids"
FRONTEND_PID_FILE="$PID_DIR/frontend.pid"

# Log file location
LOG_DIR="$SCRIPT_DIR/.logs"
FRONTEND_LOG="$LOG_DIR/frontend.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if a port is in use
port_in_use() {
    lsof -i ":$1" >/dev/null 2>&1
}

# Wait for a port to become available
wait_for_port() {
    local port=$1
    local max_attempts=${2:-30}
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if port_in_use "$port"; then
            return 0
        fi
        sleep 1
        attempt=$((attempt + 1))
    done
    return 1
}

# Check prerequisites
check_prerequisites() {
    print_header "Checking Prerequisites"

    local missing=()

    # Check Node.js
    if command_exists node; then
        local node_version=$(node --version | grep -oE '[0-9]+' | head -1)
        if [ "$node_version" -ge 18 ]; then
            print_success "Node.js v$(node --version | tr -d 'v') is installed (required: 18+)"
        else
            print_warning "Node.js v$(node --version | tr -d 'v') found, but 18+ recommended"
        fi
    else
        missing+=("node")
        print_error "Node.js is not installed"
        echo "         Install from: https://nodejs.org/"
        echo "         Or use: brew install node (macOS)"
        echo "         Or use: nvm install 20 (with nvm)"
    fi

    # Check npm
    if ! command_exists npm; then
        missing+=("npm")
        print_error "npm is not installed"
        echo "         npm comes with Node.js installation"
    fi

    if [ ${#missing[@]} -gt 0 ]; then
        echo ""
        print_error "Missing prerequisites: ${missing[*]}"
        echo "         Please install the missing tools and try again"
        exit 1
    fi

    echo ""
    print_success "All prerequisites satisfied"
}

# Setup frontend and install dependencies
setup_frontend() {
    print_header "Setting Up Frontend"

    if [ ! -d "$FRONTEND_DIR" ]; then
        print_error "Frontend directory not found: $FRONTEND_DIR"
        exit 1
    fi

    # Install npm dependencies if node_modules doesn't exist or package.json is newer
    if [ ! -d "$FRONTEND_DIR/node_modules" ] || \
       [ "$FRONTEND_DIR/package.json" -nt "$FRONTEND_DIR/node_modules" ]; then
        print_info "Installing npm dependencies..."
        (cd "$FRONTEND_DIR" && npm install --silent)
        print_success "npm dependencies installed"
    else
        print_success "npm dependencies up to date"
    fi
}

# Start frontend server
start_frontend() {
    print_header "Starting Frontend Server"

    if [ ! -d "$FRONTEND_DIR" ]; then
        print_error "Frontend directory not found - cannot start"
        exit 1
    fi

    if port_in_use $FRONTEND_PORT; then
        print_warning "Port $FRONTEND_PORT already in use - frontend may already be running"
        echo "         Run ./kill-local.sh to stop existing services"
        return 0
    fi

    # Create directories
    mkdir -p "$PID_DIR" "$LOG_DIR"

    print_info "Starting Vite development server on port $FRONTEND_PORT..."

    (cd "$FRONTEND_DIR" && \
        nohup npm run dev > "$FRONTEND_LOG" 2>&1 &
        echo $! > "$FRONTEND_PID_FILE"
    )

    # Wait for frontend to start
    if wait_for_port $FRONTEND_PORT 30; then
        print_success "Frontend started on http://localhost:$FRONTEND_PORT"
        print_info "Frontend logs: $FRONTEND_LOG"
    else
        print_error "Frontend failed to start. Check logs: $FRONTEND_LOG"
        if [ -f "$FRONTEND_LOG" ]; then
            echo "         Last 10 lines of log:"
            tail -10 "$FRONTEND_LOG" | sed 's/^/         /'
        fi
    fi
}

# Print summary
print_summary() {
    print_header "Development Environment Ready"

    echo ""
    echo -e "${GREEN}Services:${NC}"

    if port_in_use $FRONTEND_PORT; then
        echo -e "  ${GREEN}Frontend${NC}    http://localhost:$FRONTEND_PORT"
    fi

{{#hasBackend}}
    echo ""
    echo -e "${YELLOW}Note:${NC} This project has a backend module."
    echo "      Start the backend separately using its own local.sh script."
{{/hasBackend}}

    echo ""
    echo -e "${YELLOW}Logs:${NC}"
    echo "  Frontend: $FRONTEND_LOG"

    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo "  Stop services:      ./kill-local.sh"
    echo "  View frontend logs: tail -f $FRONTEND_LOG"
    echo ""
}

# Main execution
main() {
    echo ""
    echo -e "${BLUE}Starting local development environment for ${PROJECT_NAME}${NC}"
    echo ""

    check_prerequisites
    setup_frontend
    start_frontend
    print_summary
}

main "$@"
