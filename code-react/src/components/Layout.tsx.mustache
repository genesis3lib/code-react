import { useEffect, useRef, useState } from 'react';
import { Link, useLocation, useOutlet } from 'react-router-dom';
import { version } from '../utils/version';
import { PAGE_TRANSITION_DURATION } from '../utils/config';

export function Layout() {
  const location = useLocation();
  const outlet = useOutlet();

  // Page transition state
  const [displayOutlet, setDisplayOutlet] = useState(outlet);
  const [isVisible, setIsVisible] = useState(true);
  const prevPathRef = useRef(location.pathname);

  useEffect(() => {
    if (location.pathname !== prevPathRef.current) {
      // Fade out
      setIsVisible(false);

      const timer = setTimeout(() => {
        prevPathRef.current = location.pathname;
        setDisplayOutlet(outlet);
        // Fade in
        setIsVisible(true);
      }, PAGE_TRANSITION_DURATION);

      return () => clearTimeout(timer);
    }
  }, [location.pathname, outlet]);

  return (
    <div className="flex min-h-screen flex-col">
      {/* Navigation - Sticky at top */}
      <nav className="sticky top-0 z-50 border-b border-border bg-background">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div className="flex h-16 items-center justify-between">
            <div className="flex items-center gap-8">
              <Link to="/" className="text-xl font-bold text-foreground">
                {{{projectName}}}
              </Link>
              <Link to="/" className="text-sm font-medium text-foreground/80 hover:text-foreground">
                Home
              </Link>
            </div>
{{#hasAuth}}
            <Link to="/profile" className="text-sm font-medium text-foreground/80 hover:text-foreground">
              Profile
            </Link>
{{/hasAuth}}
          </div>
        </div>
      </nav>

      {/* Main content with page transition */}
      <main className="flex-1">
        <div
          className={`h-full w-full transition-opacity ${isVisible ? 'opacity-100' : 'opacity-0'}`}
          style={{ transitionDuration: `${PAGE_TRANSITION_DURATION}ms` }}
        >
          {displayOutlet}
        </div>
      </main>

      {/* Footer */}
      <footer className="border-t border-border bg-background">
        <div className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
          <div className="flex flex-col items-center gap-4">
            <div className="flex gap-6">
              <Link to="/about" className="text-sm text-muted-foreground hover:text-foreground">
                About
              </Link>
              <Link to="/terms" className="text-sm text-muted-foreground hover:text-foreground">
                Terms
              </Link>
              <Link to="/version" className="text-sm text-muted-foreground hover:text-foreground">
                {version.sha}
              </Link>
            </div>
            <p className="text-center text-xs text-muted-foreground">
              Â© {new Date().getFullYear()} {{{projectName}}}. All rights reserved.
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
}
